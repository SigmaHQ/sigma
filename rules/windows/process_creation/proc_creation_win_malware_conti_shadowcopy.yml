title: Sensitive Registry Access via Volume Shadow Copy
id: f57f8d16-1f39-4dcb-a604-6c73d9b54b3d
description: Detects a command that accesses password storing registry hives via volume shadow backups
author: Max Altgelt, Tobias Michalski
date: 2021/08/09
modified: 2022/08/13
status: experimental
references:
    - https://twitter.com/vxunderground/status/1423336151860002816?s=20
    - https://www.virustotal.com/gui/file/03e9b8c2e86d6db450e5eceec057d7e369ee2389b9daecaf06331a95410aa5f8/detection
    - https://pentestlab.blog/2018/07/04/dumping-domain-password-hashes/
logsource:
    category: process_creation
    product: windows
detection:
    selection_1:
        #copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\NTDS\NTDS.dit C:\temp\ntds.dit 2>&1
        CommandLine|contains: '\\\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy'
    selection_2:
        CommandLine|contains:
            - '\\NTDS.dit'
            - '\\SYSTEM'
            - '\\SECURITY'
            - 'C:\\tmp\\log'
    condition: all of selection*
falsepositives:
    - Some rare backup scenarios
level: medium
tags:
    - attack.impact
    - attack.t1490